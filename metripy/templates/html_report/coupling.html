<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coupling Analysis - Code Metrics Dashboard</title>
    <link rel="stylesheet" href="css/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="images/logo.svg" sizes="any" type="image/svg+xml">
    <link rel="stylesheet" href="css/coupling.css">
    <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body>
    <div class="dashboard">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <img src="images/logo.svg" alt="Metripy Logo" class="logo-icon">
                    <h2>Metripy</h2>
                </div>
            </div>
            
            <nav class="sidebar-nav">
                <ul>
                    <li class="nav-item">
                        <a href="index.html" class="nav-link">
                            <i class="fas fa-tachometer-alt"></i>
                            <span>Overview</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="files.html" class="nav-link">
                            <i class="fas fa-file-code"></i>
                            <span>Files</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="top_offenders.html" class="nav-link">
                            <i class="fa-solid fa-stethoscope"></i>
                            <span>Top Offenders</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="git_analysis.html" class="nav-link">
                            <i class="fab fa-git-alt"></i>
                            <span>Git Analysis</span>
                        </a>
                    </li>
                    <li class="nav-item active">
                        <a href="coupling.html" class="nav-link">
                            <i class="fas fa-project-diagram"></i>
                            <span>Coupling</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="dependencies.html" class="nav-link">
                            <i class="fas fa-cubes"></i>
                            <span>Dependencies</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="trends.html" class="nav-link">
                            <i class="fas fa-chart-line"></i>
                            <span>Trends</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="code_smells.html" class="nav-link">
                            <i class="fas fa-bug"></i>
                            <span>Code Smells</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="metrics.html" class="nav-link">
                            <i class="fas fa-info-circle"></i>
                            <span>Explanations</span>
                        </a>
                    </li>
                </ul>
            </nav>
            
            <div class="sidebar-footer">
                <div class="project-info">
                    <h4>Project: {{ project_name }}</h4>
                    <p>Last updated: {{ last_updated }}</p>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="page-header">
                <div class="header-content">
                    <h1>Coupling Analysis</h1>
                    <p class="subtitle">Visualize and analyze module dependencies and coupling metrics</p>
                </div>
            </header>

            <!-- Statistics Overview -->
            <section class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="total-modules">0</div>
                    <div class="stat-label">Total Modules</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="total-dependencies">0</div>
                    <div class="stat-label">Dependencies</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avg-instability">0.00</div>
                    <div class="stat-label">Avg Instability</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="max-coupling">0</div>
                    <div class="stat-label">Max Coupling</div>
                </div>
            </section>

            <!-- Dependency Graph -->
            <div class="coupling-card" style="grid-column: 1 / -1;">
                <h2>
                    <i class="fas fa-project-diagram"></i>
                    Dependency Graph
                </h2>

                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-symbol" style="background: #22c55e;"></div>
                        <span>Stable (I ≤ 0.3)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-symbol" style="background: #eab308;"></div>
                        <span>Neutral (0.3 < I ≤ 0.7)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-symbol" style="background: #ef4444;"></div>
                        <span>Unstable (I > 0.7)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-symbol" style="background: #94a3b8; border-radius: 0;"></div>
                        <span>Dependency Link</span>
                    </div>
                </div>

                <div class="graph-controls">
                    <div class="control-group">
                        <label>Layout:</label>
                        <button class="control-btn active" onclick="setLayout('force')">Force</button>
                        <button class="control-btn" onclick="setLayout('circular')">Circular</button>
                        <button class="control-btn" onclick="setLayout('hierarchical')">Hierarchical</button>
                    </div>
                    <div class="control-group">
                        <button class="control-btn" onclick="resetGraph()">
                            <i class="fas fa-sync-alt"></i> Reset View
                        </button>
                    </div>
                </div>

                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="module-search" placeholder="Search modules..." onkeyup="searchModules()">
                </div>

                <div id="dependency-graph"></div>
            </div>

            <!-- Coupling Metrics Table -->
            <div class="coupling-card" style="grid-column: 1 / -1;">
                <h2>
                    <i class="fas fa-table"></i>
                    Coupling Metrics
                </h2>

                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="table-search" placeholder="Filter modules..." onkeyup="filterTable()">
                </div>

                <div style="overflow-x: auto;">
                    <table class="metrics-table" id="coupling-table">
                        <thead>
                            <tr>
                                <th onclick="sortTable(0)">Module <i class="fas fa-sort"></i></th>
                                <th onclick="sortTable(1)">Afferent (Ca) <i class="fas fa-sort"></i></th>
                                <th onclick="sortTable(2)">Efferent (Ce) <i class="fas fa-sort"></i></th>
                                <th onclick="sortTable(3)">Instability (I) <i class="fas fa-sort"></i></th>
                                <th>Imports</th>
                                <th>Imported By</th>
                            </tr>
                        </thead>
                        <tbody id="coupling-table-body">
                            <!-- Populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Data from template
        const metricsData = {{ metrics_json }};

        // Process data for visualization
        const modules = metricsData.filter(m => m.import_name && m.imports);
        
        // Calculate statistics
        const totalDependencies = modules.reduce((sum, m) => sum + (m.imports ? m.imports.length : 0), 0);
        const avgInstability = modules.length > 0 
            ? (modules.reduce((sum, m) => sum + m.instability, 0) / modules.length).toFixed(2)
            : 0;
        const maxCoupling = Math.max(...modules.map(m => m.afferent_coupling + m.efferent_coupling), 0);

        // Update statistics
        document.getElementById('total-modules').textContent = modules.length;
        document.getElementById('total-dependencies').textContent = totalDependencies;
        document.getElementById('avg-instability').textContent = avgInstability;
        document.getElementById('max-coupling').textContent = maxCoupling;

        // Initialize table
        function initializeTable() {
            const tbody = document.getElementById('coupling-table-body');
            tbody.innerHTML = '';

            modules.forEach(module => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><span class="module-name">${module.import_name}</span></td>
                    <td>
                        <span class="coupling-badge ${getCouplingClass(module.afferent_coupling)}">
                            ${module.afferent_coupling}
                        </span>
                    </td>
                    <td>
                        <span class="coupling-badge ${getCouplingClass(module.efferent_coupling)}">
                            ${module.efferent_coupling}
                        </span>
                    </td>
                    <td>
                        <div class="instability-bar">
                            <div class="instability-bar-fill">
                                <div class="instability-bar-fill-inner" style="width: ${module.instability * 100}%; background: ${getInstabilityColor(module.instability)};"></div>
                            </div>
                            <span class="instability-value">${module.instability.toFixed(2)}</span>
                        </div>
                    </td>
                    <td>${module.imports ? module.imports.join(', ') : '-'}</td>
                    <td>${module.imported_by && module.imported_by.length > 0 ? module.imported_by.join(', ') : '-'}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function getCouplingClass(value) {
            if (value <= 2) return 'low';
            if (value <= 5) return 'medium';
            return 'high';
        }

        function getInstabilityColor(value) {
            if (value <= 0.3) return '#22c55e';
            if (value <= 0.7) return '#eab308';
            return '#ef4444';
        }

        function getNodeColor(instability) {
            if (instability <= 0.3) return '#22c55e';
            if (instability <= 0.7) return '#eab308';
            return '#ef4444';
        }

        function filterTable() {
            const searchValue = document.getElementById('table-search').value.toLowerCase();
            const rows = document.querySelectorAll('#coupling-table-body tr');

            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchValue) ? '' : 'none';
            });
        }

        let sortDirection = {};
        function sortTable(columnIndex) {
            const tbody = document.getElementById('coupling-table-body');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            sortDirection[columnIndex] = !sortDirection[columnIndex];
            const direction = sortDirection[columnIndex] ? 1 : -1;

            rows.sort((a, b) => {
                let aValue = a.cells[columnIndex].textContent.trim();
                let bValue = b.cells[columnIndex].textContent.trim();

                // Try to parse as numbers
                const aNum = parseFloat(aValue);
                const bNum = parseFloat(bValue);

                if (!isNaN(aNum) && !isNaN(bNum)) {
                    return direction * (aNum - bNum);
                }

                return direction * aValue.localeCompare(bValue);
            });

            tbody.innerHTML = '';
            rows.forEach(row => tbody.appendChild(row));
        }

        // D3.js Dependency Graph
        let svg, simulation, currentLayout = 'force';
        
        function initializeGraph() {
            const container = document.getElementById('dependency-graph');
            const width = container.clientWidth;
            const height = container.clientHeight;

            // Clear existing
            d3.select('#dependency-graph').selectAll('*').remove();

            svg = d3.select('#dependency-graph')
                .append('svg')
                .attr('width', width)
                .attr('height', height);

            // Add zoom behavior
            const g = svg.append('g');
            
            const zoom = d3.zoom()
                .scaleExtent([0.1, 4])
                .on('zoom', (event) => {
                    g.attr('transform', event.transform);
                });
            
            svg.call(zoom);

            // Create nodes and links
            const nodes = modules.map(m => ({
                id: m.import_name,
                name: m.import_name.split('.').pop(),
                fullName: m.import_name,
                instability: m.instability,
                afferent: m.afferent_coupling,
                efferent: m.efferent_coupling,
                imports: m.imports || [],
                importedBy: m.imported_by || []
            }));

            const links = [];
            modules.forEach(m => {
                if (m.imports) {
                    m.imports.forEach(imp => {
                        const target = nodes.find(n => n.id === imp);
                        if (target) {
                            links.push({
                                source: m.import_name,
                                target: imp
                            });
                        }
                    });
                }
            });

            // Define arrow marker
            svg.append('defs').append('marker')
                .attr('id', 'arrowhead')
                .attr('viewBox', '-0 -5 10 10')
                .attr('refX', 20)
                .attr('refY', 0)
                .attr('orient', 'auto')
                .attr('markerWidth', 6)
                .attr('markerHeight', 6)
                .append('path')
                .attr('d', 'M 0,-5 L 10,0 L 0,5')
                .attr('class', 'link-arrow');

            // Create links
            const link = g.append('g')
                .selectAll('line')
                .data(links)
                .enter()
                .append('line')
                .attr('class', 'link')
                .attr('marker-end', 'url(#arrowhead)');

            // Create nodes
            const node = g.append('g')
                .selectAll('circle')
                .data(nodes)
                .enter()
                .append('circle')
                .attr('class', 'node')
                .attr('r', d => 8 + (d.afferent + d.efferent))
                .attr('fill', d => getNodeColor(d.instability))
                .attr('stroke', '#fff')
                .attr('stroke-width', 2)
                .call(d3.drag()
                    .on('start', dragStarted)
                    .on('drag', dragged)
                    .on('end', dragEnded))
                .on('click', showNodeDetails)
                .on('mouseover', highlightNode)
                .on('mouseout', unhighlightNode);

            // Add labels
            const labels = g.append('g')
                .selectAll('text')
                .data(nodes)
                .enter()
                .append('text')
                .attr('class', 'node-label')
                .attr('text-anchor', 'middle')
                .attr('dy', -15)
                .text(d => d.name);

            // Create force simulation
            simulation = d3.forceSimulation(nodes)
                .force('link', d3.forceLink(links).id(d => d.id).distance(100))
                .force('charge', d3.forceManyBody().strength(-300))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('collision', d3.forceCollide().radius(d => 15 + (d.afferent + d.efferent)))
                .on('tick', () => {
                    link
                        .attr('x1', d => d.source.x)
                        .attr('y1', d => d.source.y)
                        .attr('x2', d => d.target.x)
                        .attr('y2', d => d.target.y);

                    node
                        .attr('cx', d => d.x)
                        .attr('cy', d => d.y);

                    labels
                        .attr('x', d => d.x)
                        .attr('y', d => d.y);
                });

            // Store references for later use
            window.graphElements = { g, nodes, links, link, node, labels, width, height };
        }

        function dragStarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }

        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }

        function dragEnded(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }

        function highlightNode(event, d) {
            const { link, node } = window.graphElements;
            
            // Highlight connected links
            link.classed('highlighted', l => l.source.id === d.id || l.target.id === d.id);
            
            // Dim unconnected nodes
            node.style('opacity', n => {
                if (n.id === d.id) return 1;
                const connected = window.graphElements.links.some(l => 
                    (l.source.id === d.id && l.target.id === n.id) ||
                    (l.target.id === d.id && l.source.id === n.id)
                );
                return connected ? 1 : 0.3;
            });

            // Show tooltip
            showTooltip(event, d);
        }

        function unhighlightNode() {
            const { link, node } = window.graphElements;
            link.classed('highlighted', false);
            node.style('opacity', 1);
            hideTooltip();
        }

        function showNodeDetails(event, d) {
            alert(`Module: ${d.fullName}\nInstability: ${d.instability.toFixed(2)}\nAfferent Coupling: ${d.afferent}\nEfferent Coupling: ${d.efferent}`);
        }

        let tooltip;
        function showTooltip(event, d) {
            if (!tooltip) {
                tooltip = d3.select('body')
                    .append('div')
                    .attr('class', 'tooltip')
                    .style('opacity', 0);
            }

            tooltip.transition()
                .duration(200)
                .style('opacity', 1);

            tooltip.html(`
                <div class="tooltip-title">${d.fullName}</div>
                <div class="tooltip-row">
                    <span class="tooltip-label">Instability:</span>
                    <span>${d.instability.toFixed(2)}</span>
                </div>
                <div class="tooltip-row">
                    <span class="tooltip-label">Afferent (Ca):</span>
                    <span>${d.afferent}</span>
                </div>
                <div class="tooltip-row">
                    <span class="tooltip-label">Efferent (Ce):</span>
                    <span>${d.efferent}</span>
                </div>
                <div class="tooltip-row">
                    <span class="tooltip-label">Imports:</span>
                    <span>${d.imports.length}</span>
                </div>
                <div class="tooltip-row">
                    <span class="tooltip-label">Imported By:</span>
                    <span>${d.importedBy.length}</span>
                </div>
            `)
            .style('left', (event.pageX + 10) + 'px')
            .style('top', (event.pageY - 10) + 'px');
        }

        function hideTooltip() {
            if (tooltip) {
                tooltip.transition()
                    .duration(200)
                    .style('opacity', 0);
            }
        }

        function setLayout(layout) {
            currentLayout = layout;
            
            // Update button states
            document.querySelectorAll('.control-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Apply layout
            const { nodes, width, height } = window.graphElements;

            if (layout === 'circular') {
                const radius = Math.min(width, height) / 3;
                nodes.forEach((d, i) => {
                    const angle = (i / nodes.length) * 2 * Math.PI;
                    d.fx = width / 2 + radius * Math.cos(angle);
                    d.fy = height / 2 + radius * Math.sin(angle);
                });
                simulation.alpha(1).restart();
            } else if (layout === 'hierarchical') {
                // Simple hierarchical layout based on efferent coupling
                nodes.sort((a, b) => a.efferent - b.efferent);
                const layers = Math.ceil(Math.sqrt(nodes.length));
                const nodesPerLayer = Math.ceil(nodes.length / layers);
                
                nodes.forEach((d, i) => {
                    const layer = Math.floor(i / nodesPerLayer);
                    const posInLayer = i % nodesPerLayer;
                    d.fx = (width / (nodesPerLayer + 1)) * (posInLayer + 1);
                    d.fy = (height / (layers + 1)) * (layer + 1);
                });
                simulation.alpha(1).restart();
            } else {
                // Force layout
                nodes.forEach(d => {
                    d.fx = null;
                    d.fy = null;
                });
                simulation.alpha(1).restart();
            }
        }

        function resetGraph() {
            const { nodes } = window.graphElements;
            nodes.forEach(d => {
                d.fx = null;
                d.fy = null;
            });
            simulation.alpha(1).restart();
            currentLayout = 'force';
            
            // Reset button states
            document.querySelectorAll('.control-btn').forEach((btn, i) => {
                btn.classList.toggle('active', i === 0);
            });
        }

        function searchModules() {
            const searchValue = document.getElementById('module-search').value.toLowerCase();
            const { node, labels } = window.graphElements;

            if (!searchValue) {
                node.style('opacity', 1).classed('selected', false);
                labels.style('font-weight', 'normal').style('font-size', '11px');
                return;
            }

            node.style('opacity', d => d.fullName.toLowerCase().includes(searchValue) ? 1 : 0.2)
                .classed('selected', d => d.fullName.toLowerCase().includes(searchValue));

            labels.style('font-weight', d => d.fullName.toLowerCase().includes(searchValue) ? 'bold' : 'normal')
                .style('font-size', d => d.fullName.toLowerCase().includes(searchValue) ? '14px' : '11px');
        }

        // Initialize on load
        window.addEventListener('load', () => {
            initializeTable();
            initializeGraph();
        });

        // Handle window resize
        window.addEventListener('resize', () => {
            initializeGraph();
        });
    </script>
</body>
</html>

