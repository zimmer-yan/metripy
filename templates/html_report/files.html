<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Git Analysis - Code Metrics Dashboard</title>
    <link rel="stylesheet" href="css/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* file tree*/
        .file-tree {
  max-height: 600px; /* or any height you prefer */
  overflow-y: auto;
  padding: 1rem;
  background-color: #fdfdfd;
  border: 1px solid #ddd;
  border-radius: 6px;
  font-family: 'Segoe UI', sans-serif;
  font-size: 0.95rem;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
}

.file-tree ul {
  list-style: none;
  padding-left: 1.2rem;
  margin: 0;
  position: relative;
}

.file-tree ul::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0.5rem;
  bottom: 0;
  width: 1px;
  background: #ccc;
}

.file-tree li {
  position: relative;
  margin: 0.25rem 0;
  padding-left: 1rem;
}

.file-tree li::before {
  content: '';
  position: absolute;
  top: 0.75rem;
  left: 0.5rem;
  width: 0.75rem;
  height: 1px;
  background: #ccc;
}

.file-tree .folder,
.file-tree .file {
  display: inline-block;
  cursor: pointer;
  padding: 0.25rem 0.5rem;
  border-radius: 4px;
  transition: background 0.2s;
}

.file-tree .folder:hover,
.file-tree .file:hover {
  background-color: #eef6ff;
}

.file-tree .folder {
  font-weight: 600;
  color: #0078d4;
}

.file-tree .file {
  color: #333;
}

        /* file details */

        .file-details {
  font-family: 'Segoe UI', sans-serif;
  background-color: #fff;
  border: 1px solid #ddd;
  padding: 1rem 1.5rem;
  border-radius: 6px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  max-width: 700px;
  margin: 1rem auto;
}

.file-details h3 {
  margin-top: 1.5rem;
  color: #0078d4;
}

.file-details p {
  margin: 0.5rem 0;
}

.file-details ul {
  list-style: none;
  padding-left: 1rem;
}

.file-details li {
  margin-bottom: 0.5rem;
  padding-left: 0.5rem;
  border-left: 3px solid #0078d4;
}


    </style>
</head>
<body>
    <div class="dashboard">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="logo">
                    <i class="fas fa-chart-line"></i>
                    <h2>Metripy</h2>
                </div>
            </div>
            
            <nav class="sidebar-nav">
                <ul>
                    <li class="nav-item">
                        <a href="index.html" class="nav-link">
                            <i class="fas fa-tachometer-alt"></i>
                            <span>Overview</span>
                        </a>
                    </li>
                    <li class="nav-item active">
                        <a href="files.html" class="nav-link">
                            <i class="fas fa-file-code"></i>
                            <span>Files</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="git_analysis.html" class="nav-link">
                            <i class="fab fa-git-alt"></i>
                            <span>Git Analysis</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="dependencies.html" class="nav-link">
                            <i class="fas fa-cubes"></i>
                            <span>Dependencies</span>
                        </a>
                    </li>
                </ul>
            </nav>
            
            <div class="sidebar-footer">
                <div class="project-info">
                    <h4>Project: {{project_name}}</h4>
                    <p>Last updated: {{last_updated}}</p>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <header class="page-header">
                <div class="header-content">
                    <h1>File Details</h1>
                    <p class="subtitle">File details and analysis</p>
                </div>
            </header>
            
            <section class="two-column-section">
                <div class="info-card">
                    <h4>File List</h4>
                    <div class="file-tree" id="filetree">
                        <!-- filled by JS-->
                    </div>
                </div>
                <div class="info-card">
                    <h4>File View</h4>
                    <div class="file-view" id="fileview">
                        <!-- filled by JS-->
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Embed data directly from template engine
    </script>
    <script>
        const fileTreeData = {{filetree}};
        const fileDetails = {{file_details}};
        
        function getIconClass(name, numChildren) {
            const file_ext = name.split(".").pop();
            if (numChildren) {
                return 'fa-regular fa-folder';
            } else if (file_ext === "php") {
                return 'fa-brands fa-php';
            } else if (file_ext === "py") {
                return 'fa-brands fa-python';
            } else {
                return 'fa-regular fa-file';
            }
        }

        function renderTree(node) {
            if (!node) return '';

            const icon = getIconClass(node.name, node.children.length);

            let html = `<li><i class="${icon}"></i><span class="${node.children.length ? 'folder' : 'file'}" id="${node.full_name}"> ${node.name}</span>`;
            if (node.children.length > 0) {
                html += `<ul>`;
                node.children.forEach(child => {
                    html += renderTree(child);
                });
                html += `</ul>`;
            }

            html += `</li>`;
            return html;
        }

        const fileTree = document.getElementById('filetree');
        fileTree.innerHTML = `<ul>${renderTree(fileTreeData)}</ul>`


        document.querySelectorAll('.folder').forEach(folder => {
            folder.addEventListener('click', () => {
                const nextUl = folder.nextElementSibling;
                if (nextUl && nextUl.tagName === 'UL') {
                    nextUl.style.display = nextUl.style.display === 'none' ? 'block' : 'none';
                }
            });
        });

        const fileView = document.getElementById('fileview');
        document.querySelectorAll('.file').forEach(file => {
            file.addEventListener('click', () => {
                console.log('file clicked', file.id);
                const details = fileDetails[file.id];
                console.log(details);

                // Extract file name from full path
                const fileName = file.id.split('/').pop();

                // Collect all method names to filter from global functions
                const methodNames = new Set();

                const icon = getIconClass(fileName, 0);
                let html = `
                <div class="file-details">
                    <h2><i class="${icon}"></i> ${fileName}</h2>
                    <p><strong>Lines of Code:</strong> ${details.loc}</p>
                    <p><strong>Maintainability Index:</strong> ${details.maintainabilityIndex}</p>

                    <hr/>
                    <h3>Classes</h3>
                    <ul>
                `;

                details.class_nodes.forEach(node => {
                html += `<li><strong>${node.name}</strong> — Complexity: ${node.real_complexity}`;
                if (node.functions && node.functions.length > 0) {
                    html += `<ul class="methods">`;
                    node.functions.forEach(method => {
                        html += `<li>${method.name}() — Complexity: ${method.complexity}</li>`;
                        methodNames.add(method.name)
                    });
                    html += `</ul>`;
                }
                html += `</li>`;
                });

                html += `
                    </ul>
                    <hr/>
                    <h3>Global Functions</h3>
                    <ul>
                `;

                details.function_nodes.forEach(node => {
                if (!methodNames.has(node.name)) {
                    html += `<li><strong>${node.name}</strong> — Complexity: ${node.complexity}</li>`;
                }
                });

                html += `</ul></div>`;

                fileView.innerHTML = html;

            });
        });
    </script>
</body>
</html>